<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Filtro â€” Story 9:16</title>
  <style>
    :root{
      --fg:#f6f7fb;
      --btn:#1c1f27; --btn2:#2a2f3a; --radius:16px;
      --green:#28c06f;
      --pink:#ff2f7d;
      --dark:#1f1f22;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;background:#0f0f12;
      color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      display:flex;align-items:center;justify-content:center;padding:16px
    }
    .app{width:100%;max-width:540px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.18)}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden;backdrop-filter:blur(8px)}
    .viewport{position:relative;aspect-ratio:9/16;background:#000;display:grid;place-items:center;}
    video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
    .overlay{position:absolute;inset:0;pointer-events:none;}
    .frame{position:absolute;inset:0;background-position:center;background-repeat:no-repeat;background-size:contain;opacity:.98}

    /* BotÃµes flutuantes */
    .fab{position:absolute;z-index:5;pointer-events:auto;display:grid;place-items:center;border-radius:999px;}
    #switchCamFab{
      top:14px; right:14px; width:50px; height:50px;
      background:rgba(255,255,255,.2); border:1px solid rgba(255,255,255,.28);
      backdrop-filter:blur(6px);
    }
    #switchCamFab svg{width:24px;height:24px;}
    #shutter{
      left:50%; transform:translateX(-50%);
      bottom:18px; width:72px; height:72px;
      background:#d62828; border:6px solid #fff;
      pointer-events:auto;
    }
    #shutter:active{transform:translateX(-50%) scale(.97)}

    .hint{color:#b8bbc7;font-size:12px;margin:8px 12px 0}
    canvas{display:none}

    /* Barra de aÃ§Ãµes (sem sombra, mais alta) */
    .actionBar{
      position:absolute;left:0;right:0;
      bottom:80px;
      display:none;gap:10px;padding:12px;
      background:linear-gradient(180deg,transparent,rgba(0,0,0,.4) 40%,rgba(0,0,0,.6));
      pointer-events:auto;
    }
    .actionRow{
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      margin:0 12px;
    }
    .btnAction{
      flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      height:38px;border-radius:20px;border:none;cursor:pointer;color:#fff;
      font-weight:600;letter-spacing:.3px;font-size:13px;
      box-shadow:none; /* ðŸ”¥ sem sombra */
    }
    .btnDownload{background:var(--green);}
    .btnShare{background:var(--pink);}
    .btnClose{background:var(--dark);flex:0 0 80px;}
    .btnAction:active{transform:translateY(1px);}
    .ig{width:16px;height:16px;display:inline-block}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Filtro â€” Story</h1>
      <div class="chip" id="status">Pronto</div>
    </header>

    <div class="card">
      <div class="viewport" id="viewport">
        <video id="video" playsinline autoplay muted></video>

        <div class="overlay">
          <div class="frame" id="frame"></div>

          <!-- BotÃ£o de trocar cÃ¢mera -->
          <button id="switchCamFab" class="fab" aria-label="Trocar cÃ¢mera" title="Trocar cÃ¢mera">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M7 7h2l1-1h4l1 1h2a2 2 0 0 1 2 2v2" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M20 17a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2" stroke="#fff" stroke-width="1.6" stroke-linecap="round"/>
              <path d="M7 14l-3-3 3-3" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17 10l3 3-3 3" stroke="#fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <!-- BotÃ£o de tirar foto -->
          <button id="shutter" class="fab" aria-label="Tirar foto" title="Tirar foto"></button>

          <!-- Barra de aÃ§Ãµes -->
          <div class="actionBar" id="actionBar">
            <div class="actionRow">
              <button id="btnDownload" class="btnAction btnDownload">BAIXAR FOTO</button>
              <button id="btnShare" class="btnAction btnShare">
                <svg class="ig" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="3" width="18" height="18" rx="5" stroke="white" stroke-width="1.6"/>
                  <circle cx="12" cy="12" r="4" stroke="white" stroke-width="1.6"/>
                  <circle cx="17.5" cy="6.5" r="1.2" fill="white"/>
                </svg>
                COMPARTILHAR
              </button>
              <button id="btnClose" class="btnAction btnClose">FECHAR</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="hint">
      Toque no botÃ£o vermelho para tirar a foto. Depois: <strong>Baixar</strong>, <strong>Compartilhar</strong> ou <strong>Fechar</strong>.
    </p>

    <canvas id="canvas"></canvas>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusChip = document.getElementById('status');
    const frameDiv = document.getElementById('frame');
    const switchCamFab = document.getElementById('switchCamFab');
    const shutter = document.getElementById('shutter');
    const actionBar = document.getElementById('actionBar');
    const btnDownload = document.getElementById('btnDownload');
    const btnShare = document.getElementById('btnShare');
    const btnClose = document.getElementById('btnClose');

    const DEFAULT_OVERLAY_URL = "https://uploads.onecompiler.io/43zxswfqg/43zxre4k6/IMG_3573.PNG";
    frameDiv.style.backgroundImage = `url("${DEFAULT_OVERLAY_URL}")`;

    const STORY_W = 1080, STORY_H = 1920;

    let usingFacing = 'environment';
    let stream;
    let photoBlob = null;
    let photoURL = '';

    async function startCamera() {
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: usingFacing, width: {ideal: 1920}, height: {ideal: 1080} },
          audio: false
        });
        video.srcObject = stream;
        updateMirror();
        statusChip.textContent = 'CÃ¢mera pronta';
        actionBar.style.display = 'none';
        shutter.style.display = 'grid';
        photoBlob = null;
        photoURL = '';
        try { video.play(); } catch {}
      } catch (err) {
        console.error(err);
        alert('NÃ£o consegui acessar a cÃ¢mera. Verifique permissÃµes e HTTPS.');
      }
    }

    function updateMirror(){
      video.style.transform = usingFacing === 'user' ? 'scaleX(-1)' : 'none';
    }

    switchCamFab.addEventListener('click', async ()=>{
      usingFacing = (usingFacing === 'user') ? 'environment' : 'user';
      await startCamera();
    });

    function drawVideoCover(ctx, w, h){
      const vw = video.videoWidth || w;
      const vh = video.videoHeight || h;
      if (!vw || !vh) return;
      const scale = Math.max(w / vw, h / vh);
      const dw = vw * scale;
      const dh = vh * scale;
      let dx = (w - dw) / 2;
      const dy = (h - dh) / 2;

      const mirrored = getComputedStyle(video).transform.includes('matrix(-1');
      ctx.save();
      if (mirrored){
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
        dx = -dx - dw;
      }
      ctx.drawImage(video, dx, dy, dw, dh);
      ctx.restore();
    }

    function drawFrameImage(ctx, w, h){
      const bg = frameDiv.style.backgroundImage;
      if (!bg) return Promise.resolve();
      const url = bg.slice(5,-2);
      return new Promise((resolve)=>{
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = ()=>{ ctx.drawImage(img, 0, 0, w, h); resolve(); };
        img.onerror = ()=>resolve();
        img.src = url;
      });
    }

    async function takePhoto(){
      if (!stream) return;
      canvas.width = STORY_W;
      canvas.height = STORY_H;
      const ctx = canvas.getContext('2d');
      drawVideoCover(ctx, STORY_W, STORY_H);
      await drawFrameImage(ctx, STORY_W, STORY_H);

      await new Promise(res=>canvas.toBlob(b=>{ photoBlob = b; res(); }, 'image/jpeg', 0.95));
      if (photoURL) URL.revokeObjectURL(photoURL);
      photoURL = URL.createObjectURL(photoBlob);

      actionBar.style.display = 'block';
      shutter.style.display = 'none';
      statusChip.textContent = 'PrÃ©via pronta';
      try { video.pause(); } catch {}
    }

    shutter.addEventListener('click', takePhoto);

    btnClose.addEventListener('click', async ()=>{ await startCamera(); });

    btnDownload.addEventListener('click', ()=>{
      if (!photoBlob) return;
      const a = document.createElement('a');
      a.download = 'story-1080x1920.jpg';
      a.href = photoURL;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    btnShare.addEventListener('click', async ()=>{
      if (!photoBlob) return;
      const file = new File([photoBlob], 'story-1080x1920.jpg', { type: 'image/jpeg' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try{
          await navigator.share({
            files: [file],
            title: 'Foto do evento',
            text: 'Feita com o filtro do casamento âœ¨'
          });
        } catch(e){ console.log(e); }
      } else {
        window.open(photoURL, '_blank');
      }
    });

    window.addEventListener('load', startCamera);
    window.addEventListener('beforeunload', ()=>{
      if (photoURL) URL.revokeObjectURL(photoURL);
      if (stream) stream.getTracks().forEach(t=>t.stop());
    });
  </script>
</body>
</html>
